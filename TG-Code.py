import telebot
from transformers import TrOCRProcessor, VisionEncoderDecoderModel
from PIL import Image
import torch
import io
import os

bot = telebot.TeleBot('7654203891:AAFEb7yBUe5YqoP4ADJnl8Ipa7GzJlJjvt4')

processor_dir = os.path.join(".", "trocr_processor_v2")
model_dir = os.path.join(".", "trocr_model_v2")

processor = TrOCRProcessor.from_pretrained(processor_dir)
model = VisionEncoderDecoderModel.from_pretrained(model_dir)

@bot.message_handler(content_types=['text'])
def Get_Text_Message(message):
    if message.text == "/start":
        bot.send_message(message.from_user.id,
                        "–ü—Ä–∏–≤–µ—Ç –µ—â–µ —Ä–∞–∑! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä—É—Å—Å–∫–∏–π —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å."
                        "\n–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π ‚Äî —è –µ—â–µ —É—á—É—Å—å! "
                        "\nüòä–ù–∞–ø–æ–º–∏–Ω–∞—é, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: jpeg, jpg, png, bmp.")
    elif message.text == "/help":
        bot.send_message(message.from_user.id, "–í–æ—Ç —á—Ç–æ —è —É–º–µ—é:"
                                               "\n–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.  –†–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö jpeg, jpg, png, bmp."
                                               "\n–°–æ–≤–µ—Ç—ã:"
                                               "\n–î–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –¥–µ–ª–∞—Ç—å —á–µ—Ç–∫–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–µ–∫—Å—Ç–∞. –ü–æ–∫–∞ —è –ª—É—á—à–µ –≤—Å–µ–≥–æ —Å–ø—Ä–∞–≤–ª—è—é—Å—å —Å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º. "
                                               "\n‚ö†Ô∏è–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–∞–ø–∏—à–∏—Ç–µ –º–æ–µ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ —É–ª—É—á—à–∏—Ç—å –º–µ–Ω—è. –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ!")
    else:
        bot.send_message(message.from_user.id, "–ü—Ä–æ—Å—Ç–∏... –Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —Ç–µ–±—è :(\n–¢—ã –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å /help, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ!")

@bot.message_handler(content_types=['photo'])
def Handle_Photo(message):
    try:
        file_info = bot.get_file(message.photo[-1].file_id)
        downloaded_file = bot.download_file(file_info.file_path)

        image = Image.open(io.BytesIO(downloaded_file)).convert("RGB")

        pixel_values = processor(images=image, return_tensors="pt").pixel_values
        generated_ids = model.generate(pixel_values)
        text = processor.batch_decode(generated_ids, skip_special_tokens=True)[0]

        bot.send_message(message.chat.id, f"üìù‚úÖ–ì–æ—Ç–æ–≤–æ! –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å–æ–≤—Å–µ–º —Ç–æ—á–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ. –í–æ—Ç –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç —è —Ä–∞—Å–ø–æ–∑–Ω–∞–ª:\n{text}")

    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        print(e)


print("–ü—Ä–∏–≤–µ—Ç! üëã –Ø ‚Äî –±–æ—Ç –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º (–≤ —Ñ–æ—Ä–º–∞—Ç–µ jpeg, jpg, png –∏–ª–∏ bmp), –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å.\n‚ùóÔ∏è –í–∞–∂–Ω–æ : –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —è –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞—é —Å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º. –ï—Å–ª–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤, –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∂–µ."
      "\n–î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã:"
      "\n/start ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–æ –º–Ω–æ–π/help ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É"
      "\n–ñ–¥—É –≤–∞—à–µ —Ñ–æ—Ç–æ! üì∏üìù")
bot.polling(none_stop=True)
